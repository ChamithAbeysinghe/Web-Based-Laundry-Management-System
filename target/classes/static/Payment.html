<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LaundryPro — Secure Payment</title>
    <link rel="stylesheet" href="css/Payment.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- Header -->
    <header>
        <div class="header-inner">
            <a href="#" class="logo">
                <i class="fas fa-tshirt"></i>
                <span>LaundryPro Pay</span>
            </a>
        </div>
    </header>

    <main class="container">
        <!-- Payment Form (Initial State) -->
        <section id="paymentForm" class="payment-section">
            <div class="payment-card">
                <div class="payment-header">
                    <h2>Complete Your Payment</h2>
                    <p>Order Total: <strong id="orderTotalAmount">—</strong></p>
                </div>


                <!-- Payment Method -->
                <div class="payment-methods">
                    <label class="method-option active" data-method="cash">
                        <input type="radio" name="paymentMethod" value="cash" checked>
                        <div class="method-icon">
                            <i class="fas fa-money-bill-wave"></i>
                        </div>
                        <div class="method-info">
                            <h3>Cash on Delivery</h3>
                            <p>No card needed — pay when your laundry arrives.</p>
                        </div>
                    </label>

                    <label class="method-option" data-method="card">
                        <input type="radio" name="paymentMethod" value="card">
                        <div class="method-icon">
                            <i class="fas fa-credit-card"></i>
                        </div>
                        <div class="method-info">
                            <h3>Debit/Credit Card</h3>
                            <p>Secure online payment with 256-bit encryption.</p>
                        </div>
                    </label>
                </div>

                <!-- Card Form (Hidden by default) -->
                <form id="cardForm" style="display: none;">
                    <div class="form-group">
                        <label for="cardNumber">Card Number</label>
                        <div class="input-with-icon">
                            <i class="fas fa-credit-card"></i>
                            <input type="text" id="cardNumber" placeholder="1234 5678 9012 3456" maxlength="19">
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="expiry">Expiry Date</label>
                            <input type="text" id="expiry" placeholder="MM/YY" maxlength="5">
                        </div>
                        <div class="form-group">
                            <label for="cvv">CVV</label>
                            <div class="input-with-icon">
                                <i class="fas fa-lock"></i>
                                <input type="password" id="cvv" placeholder="123" maxlength="4">
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="cardName">Name on Card</label>
                        <input type="text" id="cardName" placeholder="John Doe">
                    </div>
                </form>

                <!-- Slider CAPTCHA -->
                <div class="human-verify" style="margin-top:1rem;border:1px solid #e5e7eb;border-radius:10px;padding:0.9rem;background:#fafafa;">
                    <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;">
                        <i class="fas fa-user-shield" aria-hidden="true"></i>
                        <strong>Verify you are human</strong>
                    </div>
                    <label for="humanSlider" style="display:block;margin-bottom:.35rem;color:#374151;">Slide to verify</label>
                    <input id="humanSlider" type="range" min="0" max="100" value="0" style="width:100%;">
                    <small id="humanStatus" style="display:block;margin-top:.35rem;color:#6b7280;">Drag the slider all the way to the right</small>
                </div>

                <!-- Submit Button -->
                <button id="payBtn" class="btn-primary" disabled>
                    <i class="fas fa-lock"></i> Confirm & Pay
                </button>
            </div>
        </section>

        <!-- Success Screen (Hidden by default) -->
        <section id="successScreen" class="payment-section" style="display: none;">
            <div class="success-card">
                <div class="success-icon">
                    <i class="fas fa-check-circle"></i>
                </div>
                <h2>Payment Successful!</h2>
                <p>Your laundry order is confirmed and being processed.</p>

                <div class="payment-details">
                    <div class="detail-item">
                        <span>Payment ID</span>
                        <strong id="paymentId">—</strong>
                    </div>
                    <div class="detail-item">
                        <span>Amount Paid</span>
                        <strong id="amountPaid">—</strong>
                    </div>
                    <div class="detail-item">
                        <span>Method</span>
                        <strong id="methodConfirmed">—</strong>
                    </div>
                    <div class="detail-item">
                        <span>Order ID</span>
                        <strong><a id="viewOrderDetails" href="order-tracking.html">—</a></strong>
                    </div>
                    <div class="detail-item">
                        <span>Order Status</span>
                        <span class="status-badge processing">Processing</span>
                    </div>
                </div>

                <button id="downloadReceipt" class="btn-outline">
                    <i class="fas fa-download"></i> Download Receipt
                </button>

                <a id="trackOrderLink" href="order-tracking.html" class="btn-primary" style="margin-top: 1.5rem;">
                    <i class="fas fa-route"></i> Track My Order
                </a>

                <div class="success-actions" style="margin-top: 1rem; display: flex; gap: .75rem; flex-wrap: wrap;">
                    <a href="dashboard.html" class="btn-outline">
                        <i class="fas fa-arrow-left"></i> Back to Dashboard
                    </a>
                    <a href="dashboard.html?startOrder=true" class="btn-primary">
                        <i class="fas fa-plus-circle"></i> Place Another Order
                    </a>
                </div>
            </div>
        </section>
    </main>

    <!-- Payments History -->
    <section id="paymentsHistory" class="payment-section">
        <div class="payment-card">
            <div class="payment-header">
                <h2>My Payments</h2>
                <p class="subtitle">Orders you have paid for</p>
            </div>
            <div id="paymentsList" class="payments-list">
                <p class="muted">Loading your payments...</p>
            </div>
        </div>
    </section>

    <!-- Admin Payment List Section -->
    <section id="adminPaymentList" class="payment-section" style="margin-top:2rem;">
        <h2>All Payments</h2>
        <table id="paymentsTable" style="width:100%;border-collapse:collapse;">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Order ID</th>
                    <th>Customer ID</th>
                    <th>Amount</th>
                    <th>Method</th>
                    <th>Action</th>
                </tr>
            </thead>
            <tbody>
                <!-- Payments will be loaded here -->
            </tbody>
        </table>
    </section>

    <footer>
        <div class="container">
            <p>&copy; 2025 LaundryPro. Secure • Encrypted • Trusted.</p>
        </div>
    </footer>

    <script src="js/auth.js"></script>
    <script src="js/Payment.js"></script>
    <script>
        // Render payment history for the logged-in customer
        document.addEventListener('DOMContentLoaded', function () {
            // Get current user (normalized across possible keys)
            let user = (window.Auth && Auth.getUser) ? Auth.getUser('customer') : null;
            if (!user) {
                try { user = JSON.parse(localStorage.getItem('authUser') || localStorage.getItem('user')); } catch { user = null; }
            }
            const userId = user?.id || user?.customerId || user?.userId;
            const listEl = document.getElementById('paymentsList');

            if (!listEl) return;

            if (!userId) {
                listEl.innerHTML = '<p class="muted">Please sign in to view your payments.</p>';
                return;
            }

            async function fetchJson(url) {
                const res = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
                if (!res.ok) throw new Error(await res.text());
                return res.json();
            }

            (async () => {
                try {
                    const data = await fetchJson(`http://localhost:8080/api/payments/customer/${userId}`);
                    const items = Array.isArray(data) ? data : (data.content || []);
                    if (!items.length) {
                        listEl.innerHTML = '<p class="muted">No payments found yet.</p>';
                        return;
                    }
                    listEl.innerHTML = items.map(p => `
                        <div class="payment-item">
                            <div class="left">
                                <div class="payment-id">PAY-${p.paymentId ?? 'N/A'}</div>
                                <div class="payment-date">${p.paymentDate ? new Date(p.paymentDate).toLocaleString() : ''}</div>
                            </div>
                            <div class="right">
                                <div class="payment-amount">$${Number(p.amount || 0).toFixed(2)}</div>
                                <div class="payment-method">${(p.paymentMethod || '').toString().toUpperCase()}</div>
                            </div>
                        </div>
                    `).join('');
                } catch (e) {
                    listEl.innerHTML = `<p class="muted">Failed to load payments: ${e.message}</p>`;
                }
            })();
        });

        // Fetch and display payments for admin
        function loadPayments() {
            fetch('/api/payments?page=0&size=20')
                .then(res => res.json())
                .then(data => {
                    const tbody = document.querySelector('#paymentsTable tbody');
                    tbody.innerHTML = '';
                    (data.content || []).forEach(payment => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${payment.id}</td>
                            <td>${payment.orderId}</td>
                            <td>${payment.customerId}</td>
                            <td>${payment.amount}</td>
                            <td>${payment.paymentMethod}</td>
                            <td><button onclick="deletePayment(${payment.id})" class="btn-outline">Delete</button></td>
                        `;
                        tbody.appendChild(row);
                    });
                });
        }

        // Delete payment by ID
        function deletePayment(id) {
            if (!confirm('Are you sure you want to delete this payment?')) return;
            fetch(`/api/payments/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (res.status === 204) {
                        loadPayments();
                    } else {
                        alert('Failed to delete payment.');
                    }
                });
        }

        // Load payments on page load
        window.addEventListener('DOMContentLoaded', loadPayments);
    </script>
</body>
</html>